<html>
<head>
<title>Simpletest Coverage - /home/travis/drupal_ti/lib/simpletest/extensions/coverage/coverage_data_handler.php</title>
</head>
<style type="text/css">
body {
  font-family: "Gill Sans MT", "Gill Sans", GillSans, Arial, Helvetica, sans-serif;
}
h1 {
  font-size: medium;
}
#code {
  border-spacing: 0;
}
.lineNo {
  color: #ccc;
}
.code, .lineNo {
  white-space: pre;
  font-family: monospace;
}
.covered {
  color: #090;
}
.missed {
  color: #f00;
}
.dead {
  color: #00f;
}
.comment {
  color: #333;
}
</style>
<body>
<h1 id="title">Simpletest Coverage - /home/travis/drupal_ti/lib/simpletest/extensions/coverage/coverage_data_handler.php</h1>
<table id="code">
  <tbody>
    <tr>
       <td><span class="lineNo">1</span></td>
       <td><span class="comment code">&lt;?php
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">2</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">3</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">4</span></td>
       <td><span class="comment code"> * Persists code coverage data into SQLite database and aggregate data for convienent
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">5</span></td>
       <td><span class="comment code"> * interpretation in report generator.  Be sure to not to keep an instance longer
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">6</span></td>
       <td><span class="comment code"> * than you have, otherwise you risk overwriting database edits from another process
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">7</span></td>
       <td><span class="comment code"> * also trying to make updates.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">8</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">9</span></td>
       <td><span class="comment code">class CoverageDataHandler
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">10</span></td>
       <td><span class="comment code">{
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">11</span></td>
       <td><span class="comment code">    public $db;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">12</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">13</span></td>
       <td><span class="comment code">    public function __construct($filename)
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">14</span></td>
       <td><span class="comment code">    {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">15</span></td>
       <td><span class="missed code">        $this-&gt;filename = $filename;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">16</span></td>
       <td><span class="missed code">        $this-&gt;db       = new SQLite3($filename);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">17</span></td>
       <td><span class="missed code">        if (empty($this-&gt;db)) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">18</span></td>
       <td><span class="missed code">            throw new Exception('Could not create SQLite DB ' . $filename);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">19</span></td>
       <td><span class="dead code">        }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">20</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">21</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">22</span></td>
       <td><span class="comment code">    public function createSchema()
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">23</span></td>
       <td><span class="comment code">    {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">24</span></td>
       <td><span class="missed code">        $this-&gt;db-&gt;query('CREATE TABLE untouched (filename text)');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">25</span></td>
       <td><span class="missed code">        $this-&gt;db-&gt;query('CREATE TABLE coverage (name text, coverage text)');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">26</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">27</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">28</span></td>
       <td><span class="comment code">    public function getFilenames()
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">29</span></td>
       <td><span class="comment code">    {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">30</span></td>
       <td><span class="missed code">        $filenames = array();
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">31</span></td>
       <td><span class="missed code">        $cursor    = $this-&gt;db-&gt;query('SELECT DISTINCT name FROM coverage');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">32</span></td>
       <td><span class="missed code">        while ($row = $cursor-&gt;fetchArray()) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">33</span></td>
       <td><span class="missed code">            $filenames[] = $row[0];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">34</span></td>
       <td><span class="missed code">        }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">35</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">36</span></td>
       <td><span class="missed code">        return $filenames;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">37</span></td>
       <td><span class="dead code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">38</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">39</span></td>
       <td><span class="comment code">    public function write($coverage)
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">40</span></td>
       <td><span class="comment code">    {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">41</span></td>
       <td><span class="missed code">        foreach ($coverage as $file =&gt; $lines) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">42</span></td>
       <td><span class="missed code">            $coverageStr      = serialize($lines);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">43</span></td>
       <td><span class="missed code">            $relativeFilename = self::ltrim(getcwd() . '/', $file);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">44</span></td>
       <td><span class="missed code">            $sql              = &quot;INSERT INTO coverage (name, coverage) VALUES ('$relativeFilename', '$coverageStr')&quot;;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">45</span></td>
       <td><span class="comment code">            # if this fails, check you have write permission
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">46</span></td>
       <td><span class="missed code">            $this-&gt;db-&gt;query($sql);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">47</span></td>
       <td><span class="missed code">        }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">48</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">49</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">50</span></td>
       <td><span class="comment code">    public function read()
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">51</span></td>
       <td><span class="comment code">    {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">52</span></td>
       <td><span class="missed code">        $coverage = array_flip($this-&gt;getFilenames());
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">53</span></td>
       <td><span class="missed code">        foreach ($coverage as $file =&gt; $garbage) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">54</span></td>
       <td><span class="missed code">            $coverage[$file] = $this-&gt;readFile($file);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">55</span></td>
       <td><span class="missed code">        }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">56</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">57</span></td>
       <td><span class="missed code">        return $coverage;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">58</span></td>
       <td><span class="dead code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">59</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">60</span></td>
       <td><span class="comment code">    public function readFile($file)
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">61</span></td>
       <td><span class="comment code">    {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">62</span></td>
       <td><span class="missed code">        $aggregate = array();
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">63</span></td>
       <td><span class="missed code">        $sql       = &quot;SELECT coverage FROM coverage WHERE name = '$file'&quot;;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">64</span></td>
       <td><span class="missed code">        $result    = $this-&gt;db-&gt;query($sql);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">65</span></td>
       <td><span class="missed code">        while ($row = $result-&gt;fetchArray()) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">66</span></td>
       <td><span class="missed code">            $this-&gt;aggregateCoverage($aggregate, unserialize($row[0]));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">67</span></td>
       <td><span class="missed code">        }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">68</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">69</span></td>
       <td><span class="missed code">        return $aggregate;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">70</span></td>
       <td><span class="dead code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">71</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">72</span></td>
       <td><span class="comment code">    public function aggregateCoverage(&amp;$total, $next)
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">73</span></td>
       <td><span class="comment code">    {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">74</span></td>
       <td><span class="missed code">        foreach ($next as $lineno =&gt; $code) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">75</span></td>
       <td><span class="missed code">            if (!isset($total[$lineno])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">76</span></td>
       <td><span class="missed code">                $total[$lineno] = $code;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">77</span></td>
       <td><span class="missed code">            } else {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">78</span></td>
       <td><span class="missed code">                $total[$lineno] = $this-&gt;aggregateCoverageCode($total[$lineno], $code);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">79</span></td>
       <td><span class="comment code">            }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">80</span></td>
       <td><span class="missed code">        }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">81</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">82</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">83</span></td>
       <td><span class="comment code">    public function aggregateCoverageCode($code1, $code2)
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">84</span></td>
       <td><span class="comment code">    {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">85</span></td>
       <td><span class="comment code">        switch ($code1) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">86</span></td>
       <td><span class="missed code">            case -2: return -2;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">87</span></td>
       <td><span class="missed code">            case -1: return $code2;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">88</span></td>
       <td><span class="missed code">            default:
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">89</span></td>
       <td><span class="comment code">                switch ($code2) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">90</span></td>
       <td><span class="missed code">                    case -2: return -2;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">91</span></td>
       <td><span class="missed code">                    case -1: return $code1;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">92</span></td>
       <td><span class="dead code">                }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">93</span></td>
       <td><span class="missed code">        }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">94</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">95</span></td>
       <td><span class="missed code">        return $code1 + $code2;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">96</span></td>
       <td><span class="dead code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">97</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">98</span></td>
       <td><span class="comment code">    public static function ltrim($cruft, $pristine)
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">99</span></td>
       <td><span class="comment code">    {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">100</span></td>
       <td><span class="missed code">        if (stripos($pristine, $cruft) === 0) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">101</span></td>
       <td><span class="missed code">            return substr($pristine, strlen($cruft));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">102</span></td>
       <td><span class="dead code">        }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">103</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">104</span></td>
       <td><span class="missed code">        return $pristine;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">105</span></td>
       <td><span class="dead code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">106</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">107</span></td>
       <td><span class="comment code">    public function writeUntouchedFile($file)
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">108</span></td>
       <td><span class="comment code">    {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">109</span></td>
       <td><span class="missed code">        $relativeFile = self::ltrim('./', $file);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">110</span></td>
       <td><span class="missed code">        $sql          = &quot;INSERT INTO untouched values ('$relativeFile')&quot;;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">111</span></td>
       <td><span class="missed code">        $this-&gt;db-&gt;query($sql);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">112</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">113</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">114</span></td>
       <td><span class="comment code">    public function readUntouchedFiles()
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">115</span></td>
       <td><span class="comment code">    {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">116</span></td>
       <td><span class="missed code">        $untouched = array();
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">117</span></td>
       <td><span class="missed code">        $result    = $this-&gt;db-&gt;query('SELECT filename FROM untouched ORDER BY filename');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">118</span></td>
       <td><span class="missed code">        while ($row = $result-&gt;fetchArray()) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">119</span></td>
       <td><span class="missed code">            $untouched[] = $row[0];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">120</span></td>
       <td><span class="missed code">        }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">121</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">122</span></td>
       <td><span class="missed code">        return $untouched;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">123</span></td>
       <td><span class="dead code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">124</span></td>
       <td><span class="comment code">}
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">125</span></td>
       <td><span class="comment code"></span></td>
    </tr>
  </tbody>
</table>
<h2>Legend</h2>
<dl>
  <dt><span class="missed">Missed</span></dt>
  <dd>lines code that <strong>were not</strong> excersized during program execution.</dd>
  <dt><span class="covered">Covered</span></dt>
  <dd>lines code <strong>were</strong> excersized during program execution.</dd>
  <dt><span class="comment">Comment/non executable</span></dt>
  <dd>Comment or non-executable line of code.</dd>
  <dt><span class="dead">Dead</span></dt>
  <dd>lines of code that according to xdebug could not be executed.  This is counted as coverage code because 
  in almost all cases it is code that runnable.</dd>
</dl>
</body>
</html>
