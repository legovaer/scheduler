<html>
<head>
<title>Simpletest Coverage - sites/all/modules/date/date_elements.inc</title>
</head>
<style type="text/css">
body {
  font-family: "Gill Sans MT", "Gill Sans", GillSans, Arial, Helvetica, sans-serif;
}
h1 {
  font-size: medium;
}
#code {
  border-spacing: 0;
}
.lineNo {
  color: #ccc;
}
.code, .lineNo {
  white-space: pre;
  font-family: monospace;
}
.covered {
  color: #090;
}
.missed {
  color: #f00;
}
.dead {
  color: #00f;
}
.comment {
  color: #333;
}
</style>
<body>
<h1 id="title">Simpletest Coverage - sites/all/modules/date/date_elements.inc</h1>
<table id="code">
  <tbody>
    <tr>
       <td><span class="lineNo">1</span></td>
       <td><span class="comment code">&lt;?php
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">2</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">3</span></td>
       <td><span class="comment code"> * @file
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">4</span></td>
       <td><span class="comment code"> * Date forms and form themes and validation.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">5</span></td>
       <td><span class="comment code"> *
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">6</span></td>
       <td><span class="comment code"> * All code used in form editing and processing is in this file,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">7</span></td>
       <td><span class="comment code"> * included only during form editing.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">8</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">9</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">10</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">11</span></td>
       <td><span class="comment code"> * Private implementation of hook_widget().
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">12</span></td>
       <td><span class="comment code"> *
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">13</span></td>
       <td><span class="comment code"> * The widget builds out a complex date element in the following way:
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">14</span></td>
       <td><span class="comment code"> *
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">15</span></td>
       <td><span class="comment code"> * - A field is pulled out of the database which is comprised of one or
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">16</span></td>
       <td><span class="comment code"> *   more collections of start/end dates.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">17</span></td>
       <td><span class="comment code"> *
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">18</span></td>
       <td><span class="comment code"> * - The dates in this field are all converted from the UTC values stored
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">19</span></td>
       <td><span class="comment code"> *   in the database back to the local time. This is done in #process
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">20</span></td>
       <td><span class="comment code"> *   to avoid making this change to dates that are not being processed,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">21</span></td>
       <td><span class="comment code"> *   like those hidden with #access.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">22</span></td>
       <td><span class="comment code"> *
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">23</span></td>
       <td><span class="comment code"> * - If values are empty, the field settings rules are used to determine
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">24</span></td>
       <td><span class="comment code"> *   if the default_values should be empty, now, the same, or use strtotime.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">25</span></td>
       <td><span class="comment code"> *
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">26</span></td>
       <td><span class="comment code"> * - Each start/end combination is created using the date_combo element type
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">27</span></td>
       <td><span class="comment code"> *   defined by the date module. If the timezone is date-specific, a
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">28</span></td>
       <td><span class="comment code"> *   timezone selector is added to the first combo element.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">29</span></td>
       <td><span class="comment code"> *
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">30</span></td>
       <td><span class="comment code"> * - The date combo element creates two individual date elements, one each
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">31</span></td>
       <td><span class="comment code"> *   for the start and end field, using the appropriate individual Date API
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">32</span></td>
       <td><span class="comment code"> *   date elements, like selects, textfields, or popups.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">33</span></td>
       <td><span class="comment code"> *
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">34</span></td>
       <td><span class="comment code"> * - In the individual element validation, the data supplied by the user is
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">35</span></td>
       <td><span class="comment code"> *   used to update the individual date values.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">36</span></td>
       <td><span class="comment code"> *
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">37</span></td>
       <td><span class="comment code"> * - In the combo date validation, the timezone is updated, if necessary,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">38</span></td>
       <td><span class="comment code"> *   then the user input date values are used with that timezone to create
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">39</span></td>
       <td><span class="comment code"> *   date objects, which are used update combo date timezone and offset values.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">40</span></td>
       <td><span class="comment code"> *
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">41</span></td>
       <td><span class="comment code"> * - In the field's submission processing, the new date values, which are in
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">42</span></td>
       <td><span class="comment code"> *   the local timezone, are converted back to their UTC values and stored.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">43</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">44</span></td>
       <td><span class="covered code">function date_field_widget_form(&amp;$form, &amp;$form_state, $field, $instance, $langcode, $items, $delta, $base) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">45</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">46</span></td>
       <td><span class="missed code">  $element = $base;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">47</span></td>
       <td><span class="missed code">  $field_name = $field['field_name'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">48</span></td>
       <td><span class="missed code">  $entity_type = $instance['entity_type'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">49</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">50</span></td>
       <td><span class="comment code">  // If this is a new entity, populate the field with the right default values.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">51</span></td>
       <td><span class="comment code">  // This happens early so even fields later hidden with #access get those values.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">52</span></td>
       <td><span class="comment code">  // We should only add default values to new entities, to avoid over-writing
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">53</span></td>
       <td><span class="comment code">  // a value that has already been set. This means we can't just check to see
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">54</span></td>
       <td><span class="comment code">  // if $items is empty, because it might have been set that way on purpose.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">55</span></td>
       <td><span class="comment code">  // @see date_field_widget_properties_alter() where we flagged if this is a new entity.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">56</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">57</span></td>
       <td><span class="comment code">  // We check !isset($items[$delta]['value']) because entity translation may create
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">58</span></td>
       <td><span class="comment code">  // a new translation entity for an existing entity and we don't want to clobber
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">59</span></td>
       <td><span class="comment code">  // values that were already set in that case.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">60</span></td>
       <td><span class="comment code">  // @see http://drupal.org/node/1478848.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">61</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">62</span></td>
       <td><span class="missed code">  $is_default = FALSE;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">63</span></td>
       <td><span class="missed code">  if (!empty($instance['widget']['is_new']) &amp;&amp; !isset($items[$delta]['value'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">64</span></td>
       <td><span class="missed code">    $items = date_default_value($field, $instance, $langcode);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">65</span></td>
       <td><span class="missed code">    $is_default = TRUE;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">66</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">67</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">68</span></td>
       <td><span class="comment code">  // @TODO Repeating dates should probably be made into their own field type and completely separated out.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">69</span></td>
       <td><span class="comment code">  // That will have to wait for a new branch since it may break other things, including other modules
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">70</span></td>
       <td><span class="comment code">  // that have an expectation of what the date field types are.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">71</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">72</span></td>
       <td><span class="comment code">  // Since repeating dates cannot use the default Add more button, we have to handle our own behaviors here.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">73</span></td>
       <td><span class="comment code">  // Return only the first multiple value for repeating dates, then clean up the 'Add more' bits in #after_build.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">74</span></td>
       <td><span class="comment code">  // The repeating values will be re-generated when the repeat widget form is validated.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">75</span></td>
       <td><span class="comment code">  // At this point we can't tell if this form element is going to be hidden by #access, and we're going to
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">76</span></td>
       <td><span class="comment code">  // lose all but the first value by doing this, so store the original values in case we need to replace them later.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">77</span></td>
       <td><span class="missed code">  if (!empty($field['settings']['repeat'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">78</span></td>
       <td><span class="missed code">    if ($delta == 0) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">79</span></td>
       <td><span class="missed code">      $form['#after_build'][] = 'date_repeat_after_build';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">80</span></td>
       <td><span class="missed code">      $form_state['storage']['repeat_fields'][$field_name] = array_merge($form['#parents'], array($field_name));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">81</span></td>
       <td><span class="missed code">      $form_state['storage']['date_items'][$field_name][$langcode] = $items;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">82</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">83</span></td>
       <td><span class="comment code">    else {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">84</span></td>
       <td><span class="missed code">      return;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">85</span></td>
       <td><span class="comment code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">86</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">87</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">88</span></td>
       <td><span class="missed code">  module_load_include('inc', 'date_api', 'date_api_elements');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">89</span></td>
       <td><span class="missed code">  $timezone = date_get_timezone($field['settings']['tz_handling'], isset($items[$delta]['timezone']) ? $items[$delta]['timezone'] : date_default_timezone());
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">90</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">91</span></td>
       <td><span class="comment code">  // TODO see if there's a way to keep the timezone element from ever being
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">92</span></td>
       <td><span class="comment code">  // nested as array('timezone' =&gt; 'timezone' =&gt; value)). After struggling
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">93</span></td>
       <td><span class="comment code">  // with this a while, I can find no way to get it displayed in the form
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">94</span></td>
       <td><span class="comment code">  // correctly and get it to use the timezone element without ending up
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">95</span></td>
       <td><span class="comment code">  // with nesting.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">96</span></td>
       <td><span class="missed code">  if (is_array($timezone)) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">97</span></td>
       <td><span class="missed code">    $timezone = $timezone['timezone'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">98</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">99</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">100</span></td>
       <td><span class="comment code">  $element += array(
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">101</span></td>
       <td><span class="missed code">    '#type' =&gt; 'date_combo',
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">102</span></td>
       <td><span class="missed code">    '#theme_wrappers' =&gt; array('date_combo'),
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">103</span></td>
       <td><span class="missed code">    '#weight' =&gt; $delta,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">104</span></td>
       <td><span class="missed code">    '#default_value' =&gt; isset($items[$delta]) ? $items[$delta] : '',
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">105</span></td>
       <td><span class="missed code">    '#date_timezone' =&gt; $timezone,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">106</span></td>
       <td><span class="missed code">    '#element_validate' =&gt; array('date_combo_validate'),
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">107</span></td>
       <td><span class="missed code">    '#date_is_default' =&gt; $is_default,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">108</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">109</span></td>
       <td><span class="comment code">    // Store the original values, for use with disabled and hidden fields.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">110</span></td>
       <td><span class="missed code">    '#date_items' =&gt; isset($items[$delta]) ? $items[$delta] : '',
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">111</span></td>
       <td><span class="missed code">  );
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">112</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">113</span></td>
       <td><span class="missed code">  $element['#title'] = $instance['label'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">114</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">115</span></td>
       <td><span class="missed code">  if ($field['settings']['tz_handling'] == 'date') {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">116</span></td>
       <td><span class="missed code">    $element['timezone'] = array(
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">117</span></td>
       <td><span class="missed code">      '#type' =&gt; 'date_timezone',
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">118</span></td>
       <td><span class="missed code">      '#theme_wrappers' =&gt; array('date_timezone'),
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">119</span></td>
       <td><span class="missed code">      '#delta' =&gt; $delta,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">120</span></td>
       <td><span class="missed code">      '#default_value' =&gt; $timezone,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">121</span></td>
       <td><span class="missed code">      '#weight' =&gt; $instance['widget']['weight'] + 1,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">122</span></td>
       <td><span class="missed code">      '#attributes' =&gt; array('class' =&gt; array('date-no-float')),
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">123</span></td>
       <td><span class="missed code">      '#date_label_position' =&gt; $instance['widget']['settings']['label_position'],
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">124</span></td>
       <td><span class="comment code">    );
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">125</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">126</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">127</span></td>
       <td><span class="comment code">  // Make changes if instance is set to be rendered as a regular field.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">128</span></td>
       <td><span class="missed code">  if (!empty($instance['widget']['settings']['no_fieldset'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">129</span></td>
       <td><span class="missed code">   $element['#title'] = check_plain($instance['label']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">130</span></td>
       <td><span class="missed code">   $element['#theme_wrappers'] = ($field['cardinality'] == 1) ? array('date_form_element') : array();
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">131</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">132</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">133</span></td>
       <td><span class="missed code">  return $element;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">134</span></td>
       <td><span class="dead code">}
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">135</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">136</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">137</span></td>
       <td><span class="comment code"> * Create local date object.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">138</span></td>
       <td><span class="comment code"> *
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">139</span></td>
       <td><span class="comment code"> * Create a date object set to local time from the field and
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">140</span></td>
       <td><span class="comment code"> * widget settings and item values. Default values for new entities
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">141</span></td>
       <td><span class="comment code"> * are set by the default value callback, so don't need to be accounted for here.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">142</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">143</span></td>
       <td><span class="covered code">function date_local_date($item, $timezone, $field, $instance, $part = 'value') {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">144</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">145</span></td>
       <td><span class="missed code">  $value = $item[$part];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">146</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">147</span></td>
       <td><span class="comment code">  // If the value is empty, don't try to create a date object because it will
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">148</span></td>
       <td><span class="comment code">  // end up being the current day.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">149</span></td>
       <td><span class="missed code">  if (empty($value)) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">150</span></td>
       <td><span class="missed code">    return NULL;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">151</span></td>
       <td><span class="dead code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">152</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">153</span></td>
       <td><span class="comment code">  // @TODO Figure out how to replace date_fuzzy_datetime() function.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">154</span></td>
       <td><span class="comment code">  // Special case for ISO dates to create a valid date object for formatting.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">155</span></td>
       <td><span class="comment code">  // Is this still needed?
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">156</span></td>
       <td><span class="comment code">  // @codingStandardsIgnoreStart
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">157</span></td>
       <td><span class="comment code">  /*
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">158</span></td>
       <td><span class="comment code">  if ($field['type'] == DATE_ISO) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">159</span></td>
       <td><span class="comment code">    $value = date_fuzzy_datetime($value);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">160</span></td>
       <td><span class="comment code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">161</span></td>
       <td><span class="comment code">  else {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">162</span></td>
       <td><span class="comment code">    $db_timezone = date_get_timezone_db($field['settings']['tz_handling']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">163</span></td>
       <td><span class="comment code">    $value = date_convert($value, $field['type'], DATE_DATETIME, $db_timezone);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">164</span></td>
       <td><span class="comment code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">165</span></td>
       <td><span class="comment code">  */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">166</span></td>
       <td><span class="comment code">  // @codingStandardsIgnoreEnd
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">167</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">168</span></td>
       <td><span class="missed code">  $date = new DateObject($value, date_get_timezone_db($field['settings']['tz_handling']));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">169</span></td>
       <td><span class="missed code">  $date-&gt;limitGranularity($field['settings']['granularity']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">170</span></td>
       <td><span class="missed code">  if (empty($date)) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">171</span></td>
       <td><span class="missed code">    return NULL;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">172</span></td>
       <td><span class="dead code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">173</span></td>
       <td><span class="missed code">  date_timezone_set($date, timezone_open($timezone));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">174</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">175</span></td>
       <td><span class="missed code">  return $date;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">176</span></td>
       <td><span class="dead code">}
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">177</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">178</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">179</span></td>
       <td><span class="comment code"> * The callback for setting a default value for an empty date field.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">180</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">181</span></td>
       <td><span class="covered code">function date_default_value($field, $instance, $langcode) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">182</span></td>
       <td><span class="missed code">  $item = array();
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">183</span></td>
       <td><span class="missed code">  $db_format = date_type_format($field['type']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">184</span></td>
       <td><span class="missed code">  $date = date_default_value_part($item, $field, $instance, $langcode, 'value');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">185</span></td>
       <td><span class="missed code">  $item[0]['value'] = is_object($date) ? date_format($date, $db_format) : '';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">186</span></td>
       <td><span class="missed code">  if (!empty($field['settings']['todate'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">187</span></td>
       <td><span class="missed code">    $date = date_default_value_part($item, $field, $instance, $langcode, 'value2');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">188</span></td>
       <td><span class="missed code">    $item[0]['value2'] = is_object($date) ? date_format($date, $db_format) : '';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">189</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">190</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">191</span></td>
       <td><span class="comment code">  // Make sure the default value has the same construct as a loaded field value
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">192</span></td>
       <td><span class="comment code">  // to avoid errors if the default value is used on a hidden element.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">193</span></td>
       <td><span class="missed code">  $item[0]['timezone'] = date_get_timezone($field['settings']['tz_handling']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">194</span></td>
       <td><span class="missed code">  $item[0]['timezone_db'] = date_get_timezone_db($field['settings']['tz_handling']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">195</span></td>
       <td><span class="missed code">  $item[0]['date_type'] = $field['type'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">196</span></td>
       <td><span class="missed code">  if (!isset($item[0]['value2'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">197</span></td>
       <td><span class="missed code">    $item[0]['value2'] = $item[0]['value'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">198</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">199</span></td>
       <td><span class="missed code">  return $item;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">200</span></td>
       <td><span class="dead code">}
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">201</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">202</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">203</span></td>
       <td><span class="comment code"> * Helper function for the date default value callback to set either 'value' or 'value2' to its default value.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">204</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">205</span></td>
       <td><span class="covered code">function date_default_value_part($item, $field, $instance, $langcode, $part = 'value') {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">206</span></td>
       <td><span class="missed code">  $timezone = date_get_timezone($field['settings']['tz_handling']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">207</span></td>
       <td><span class="missed code">  $timezone_db = date_get_timezone_db($field['settings']['tz_handling']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">208</span></td>
       <td><span class="missed code">  $date = NULL;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">209</span></td>
       <td><span class="missed code">  if ($part == 'value') {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">210</span></td>
       <td><span class="missed code">    $default_value = $instance['settings']['default_value'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">211</span></td>
       <td><span class="missed code">    $default_value_code = $instance['settings']['default_value_code'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">212</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">213</span></td>
       <td><span class="comment code">  else {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">214</span></td>
       <td><span class="missed code">    $default_value = $instance['settings']['default_value2'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">215</span></td>
       <td><span class="missed code">    $default_value_code = $instance['settings']['default_value_code2'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">216</span></td>
       <td><span class="comment code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">217</span></td>
       <td><span class="missed code">  if (empty($default_value) || $default_value == 'blank') {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">218</span></td>
       <td><span class="missed code">    return NULL;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">219</span></td>
       <td><span class="dead code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">220</span></td>
       <td><span class="missed code">  elseif ($default_value == 'strtotime' &amp;&amp; !empty($default_value_code)) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">221</span></td>
       <td><span class="missed code">    $date = new DateObject($default_value_code, date_default_timezone());
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">222</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">223</span></td>
       <td><span class="missed code">  elseif ($part == 'value2' &amp;&amp; $default_value == 'same') {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">224</span></td>
       <td><span class="missed code">    if ($instance['settings']['default_value'] == 'blank' || empty($item[0]['value'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">225</span></td>
       <td><span class="missed code">      return NULL;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">226</span></td>
       <td><span class="dead code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">227</span></td>
       <td><span class="comment code">    else {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">228</span></td>
       <td><span class="comment code">      // The date stored in 'value' has already been switched to the db timezone.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">229</span></td>
       <td><span class="missed code">      $date = new DateObject($item[0]['value'], $timezone_db, DATE_FORMAT_DATETIME);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">230</span></td>
       <td><span class="comment code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">231</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">232</span></td>
       <td><span class="comment code">  // Special case for 'now' when using dates with no timezone,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">233</span></td>
       <td><span class="comment code">  // make sure 'now' isn't adjusted to UTC value of 'now' .
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">234</span></td>
       <td><span class="missed code">  elseif ($field['settings']['tz_handling'] == 'none') {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">235</span></td>
       <td><span class="missed code">    $date = date_now();
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">236</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">237</span></td>
       <td><span class="comment code">  else {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">238</span></td>
       <td><span class="missed code">    $date = date_now($timezone);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">239</span></td>
       <td><span class="comment code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">240</span></td>
       <td><span class="comment code">  // The default value needs to be in the database timezone.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">241</span></td>
       <td><span class="missed code">  date_timezone_set($date, timezone_open($timezone_db));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">242</span></td>
       <td><span class="missed code">  $date-&gt;limitGranularity($field['settings']['granularity']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">243</span></td>
       <td><span class="missed code">  return $date;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">244</span></td>
       <td><span class="dead code">}
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">245</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">246</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">247</span></td>
       <td><span class="comment code"> * Process an individual date element.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">248</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">249</span></td>
       <td><span class="covered code">function date_combo_element_process($element, &amp;$form_state, $form) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">250</span></td>
       <td><span class="missed code">  if (date_hidden_element($element)) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">251</span></td>
       <td><span class="comment code">    // A hidden value for a new entity that had its end date set to blank
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">252</span></td>
       <td><span class="comment code">    // will not get processed later to populate the end date, so set it here.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">253</span></td>
       <td><span class="missed code">    if (isset($element['#value']['value2']) &amp;&amp; empty($element['#value']['value2'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">254</span></td>
       <td><span class="missed code">      $element['#value']['value2'] = $element['#value']['value'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">255</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">256</span></td>
       <td><span class="missed code">    return $element;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">257</span></td>
       <td><span class="dead code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">258</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">259</span></td>
       <td><span class="missed code">  $field_name = $element['#field_name'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">260</span></td>
       <td><span class="missed code">  $delta = $element['#delta'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">261</span></td>
       <td><span class="missed code">  $bundle = $element['#bundle'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">262</span></td>
       <td><span class="missed code">  $entity_type = $element['#entity_type'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">263</span></td>
       <td><span class="missed code">  $langcode = $element['#language'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">264</span></td>
       <td><span class="missed code">  $date_is_default = $element['#date_is_default'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">265</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">266</span></td>
       <td><span class="missed code">  $field = field_widget_field($element, $form_state);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">267</span></td>
       <td><span class="missed code">  $instance = field_widget_instance($element, $form_state);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">268</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">269</span></td>
       <td><span class="comment code">  // Figure out how many items are in the form, including new ones added by ajax.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">270</span></td>
       <td><span class="missed code">  $field_state = field_form_get_state($element['#field_parents'], $field_name, $element['#language'], $form_state);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">271</span></td>
       <td><span class="missed code">  $items_count = $field_state['items_count'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">272</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">273</span></td>
       <td><span class="missed code">  $columns = $element['#columns'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">274</span></td>
       <td><span class="missed code">  if (isset($columns['rrule'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">275</span></td>
       <td><span class="missed code">    unset($columns['rrule']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">276</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">277</span></td>
       <td><span class="missed code">  $from_field = 'value';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">278</span></td>
       <td><span class="missed code">  $to_field = 'value2';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">279</span></td>
       <td><span class="missed code">  $tz_field = 'timezone';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">280</span></td>
       <td><span class="missed code">  $offset_field = 'offset';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">281</span></td>
       <td><span class="missed code">  $offset_field2 = 'offset2';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">282</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">283</span></td>
       <td><span class="comment code">  // Convert UTC dates to their local values in DATETIME format,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">284</span></td>
       <td><span class="comment code">  // and adjust the default values as specified in the field settings.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">285</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">286</span></td>
       <td><span class="comment code">  // It would seem to make sense to do this conversion when the data
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">287</span></td>
       <td><span class="comment code">  // is loaded instead of when the form is created, but the loaded
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">288</span></td>
       <td><span class="comment code">  // field data is cached and we can't cache dates that have been converted
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">289</span></td>
       <td><span class="comment code">  // to the timezone of an individual user, so we cache the UTC values
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">290</span></td>
       <td><span class="comment code">  // instead and do our conversion to local dates in the form and
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">291</span></td>
       <td><span class="comment code">  // in the formatters.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">292</span></td>
       <td><span class="missed code">  $process = date_process_values($field, $instance);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">293</span></td>
       <td><span class="missed code">  foreach ($process as $processed) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">294</span></td>
       <td><span class="missed code">    if (!isset($element['#default_value'][$processed])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">295</span></td>
       <td><span class="missed code">      $element['#default_value'][$processed] = '';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">296</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">297</span></td>
       <td><span class="missed code">    $date = date_local_date($element['#default_value'], $element['#date_timezone'], $field, $instance, $processed);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">298</span></td>
       <td><span class="missed code">    $element['#default_value'][$processed] = is_object($date) ? date_format($date, DATE_FORMAT_DATETIME) : '';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">299</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">300</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">301</span></td>
       <td><span class="comment code">  // Blank out the end date for optional end dates that match the start date,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">302</span></td>
       <td><span class="comment code">  // except when this is a new node that has default values that should be honored.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">303</span></td>
       <td><span class="missed code">  if (!$date_is_default &amp;&amp; $field['settings']['todate'] != 'required'
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">304</span></td>
       <td><span class="missed code">  &amp;&amp; is_array($element['#default_value'])
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">305</span></td>
       <td><span class="missed code">  &amp;&amp; !empty($element['#default_value'][$to_field])
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">306</span></td>
       <td><span class="missed code">  &amp;&amp; $element['#default_value'][$to_field] == $element['#default_value'][$from_field]) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">307</span></td>
       <td><span class="missed code">    unset($element['#default_value'][$to_field]);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">308</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">309</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">310</span></td>
       <td><span class="missed code">  $show_todate = !empty($form_state['values']['show_todate']) || !empty($element['#default_value'][$to_field]) || $field['settings']['todate'] == 'required';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">311</span></td>
       <td><span class="missed code">  $element['show_todate'] = array(
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">312</span></td>
       <td><span class="missed code">    '#title' =&gt; t('Show End Date'),
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">313</span></td>
       <td><span class="missed code">    '#type' =&gt; 'checkbox',
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">314</span></td>
       <td><span class="missed code">    '#default_value' =&gt; $show_todate,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">315</span></td>
       <td><span class="missed code">    '#weight' =&gt; -20,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">316</span></td>
       <td><span class="missed code">    '#access' =&gt; $field['settings']['todate'] == 'optional',
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">317</span></td>
       <td><span class="missed code">    '#prefix' =&gt; '&lt;div class=&quot;date-float&quot;&gt;',
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">318</span></td>
       <td><span class="missed code">    '#suffix' =&gt; '&lt;/div&gt;',
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">319</span></td>
       <td><span class="comment code">  );
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">320</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">321</span></td>
       <td><span class="missed code">  $parents = $element['#parents'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">322</span></td>
       <td><span class="missed code">  $first_parent = array_shift($parents);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">323</span></td>
       <td><span class="missed code">  $show_id = $first_parent . '[' . implode('][', $parents) . '][show_todate]';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">324</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">325</span></td>
       <td><span class="missed code">  $element[$from_field] = array(
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">326</span></td>
       <td><span class="missed code">    '#field'         =&gt; $field,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">327</span></td>
       <td><span class="missed code">    '#instance'      =&gt; $instance,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">328</span></td>
       <td><span class="missed code">    '#weight'        =&gt; $instance['widget']['weight'],
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">329</span></td>
       <td><span class="missed code">    '#required'      =&gt; ($element['#required'] &amp;&amp; $delta == 0) ? 1 : 0,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">330</span></td>
       <td><span class="missed code">    '#default_value' =&gt; isset($element['#default_value'][$from_field]) ? $element['#default_value'][$from_field] : '',
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">331</span></td>
       <td><span class="missed code">    '#delta'         =&gt; $delta,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">332</span></td>
       <td><span class="missed code">    '#date_timezone' =&gt; $element['#date_timezone'],
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">333</span></td>
       <td><span class="missed code">    '#date_format'      =&gt; date_limit_format(date_input_format($element, $field, $instance), $field['settings']['granularity']),
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">334</span></td>
       <td><span class="missed code">    '#date_text_parts'  =&gt; (array) $instance['widget']['settings']['text_parts'],
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">335</span></td>
       <td><span class="missed code">    '#date_increment'   =&gt; $instance['widget']['settings']['increment'],
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">336</span></td>
       <td><span class="missed code">    '#date_year_range'  =&gt; $instance['widget']['settings']['year_range'],
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">337</span></td>
       <td><span class="missed code">    '#date_label_position' =&gt; $instance['widget']['settings']['label_position'],
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">338</span></td>
       <td><span class="comment code">  );
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">339</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">340</span></td>
       <td><span class="missed code">  $description = !empty($element['#description']) ? t($element['#description']) : '';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">341</span></td>
       <td><span class="missed code">  unset($element['#description']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">342</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">343</span></td>
       <td><span class="comment code">  // Give this element the right type, using a Date API
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">344</span></td>
       <td><span class="comment code">  // or a Date Popup element type.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">345</span></td>
       <td><span class="missed code">  $element[$from_field]['#attributes'] = array('class' =&gt; array('date-clear'));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">346</span></td>
       <td><span class="missed code">  $element[$from_field]['#wrapper_attributes'] = array('class' =&gt; array());
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">347</span></td>
       <td><span class="missed code">  $element[$from_field]['#wrapper_attributes']['class'][] = 'date-no-float';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">348</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">349</span></td>
       <td><span class="missed code">  switch ($instance['widget']['type']) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">350</span></td>
       <td><span class="missed code">    case 'date_select':
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">351</span></td>
       <td><span class="missed code">      $element[$from_field]['#type'] = 'date_select';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">352</span></td>
       <td><span class="missed code">      $element[$from_field]['#theme_wrappers'] = array('date_select');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">353</span></td>
       <td><span class="missed code">      $element['#attached']['js'][] = drupal_get_path('module', 'date') . '/date.js';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">354</span></td>
       <td><span class="missed code">      $element[$from_field]['#ajax'] = !empty($element['#ajax']) ? $element['#ajax'] : FALSE;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">355</span></td>
       <td><span class="missed code">      break;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">356</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">357</span></td>
       <td><span class="missed code">    case 'date_popup':
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">358</span></td>
       <td><span class="missed code">      $element[$from_field]['#type'] = 'date_popup';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">359</span></td>
       <td><span class="missed code">      $element[$from_field]['#theme_wrappers'] = array('date_popup');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">360</span></td>
       <td><span class="missed code">      $element[$from_field]['#ajax'] = !empty($element['#ajax']) ? $element['#ajax'] : FALSE;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">361</span></td>
       <td><span class="missed code">      break;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">362</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">363</span></td>
       <td><span class="missed code">    default:
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">364</span></td>
       <td><span class="missed code">      $element[$from_field]['#type'] = 'date_text';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">365</span></td>
       <td><span class="missed code">      $element[$from_field]['#theme_wrappers'] = array('date_text');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">366</span></td>
       <td><span class="missed code">      $element[$from_field]['#ajax'] = !empty($element['#ajax']) ? $element['#ajax'] : FALSE;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">367</span></td>
       <td><span class="missed code">      break;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">368</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">369</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">370</span></td>
       <td><span class="comment code">  // If this field uses the 'End', add matching element
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">371</span></td>
       <td><span class="comment code">  // for the 'End' date, and adapt titles to make it clear which
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">372</span></td>
       <td><span class="comment code">  // is the 'Start' and which is the 'End' .
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">373</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">374</span></td>
       <td><span class="missed code">  if (!empty($field['settings']['todate'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">375</span></td>
       <td><span class="missed code">    $element[$to_field] = $element[$from_field];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">376</span></td>
       <td><span class="missed code">    $element[$from_field]['#title_display'] = 'none';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">377</span></td>
       <td><span class="missed code">    $element[$to_field]['#title'] = t('to:');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">378</span></td>
       <td><span class="missed code">    $element[$from_field]['#wrapper_attributes']['class'][] = 'start-date-wrapper';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">379</span></td>
       <td><span class="missed code">    $element[$to_field]['#wrapper_attributes']['class'][] = 'end-date-wrapper';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">380</span></td>
       <td><span class="missed code">    $element[$to_field]['#default_value'] = isset($element['#default_value'][$to_field]) ? $element['#default_value'][$to_field] : '';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">381</span></td>
       <td><span class="missed code">    $element[$to_field]['#required'] = ($element[$from_field]['#required'] &amp;&amp; $field['settings']['todate'] == 'required');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">382</span></td>
       <td><span class="missed code">    $element[$to_field]['#weight'] += .2;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">383</span></td>
       <td><span class="missed code">    $element[$to_field]['#prefix'] = '';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">384</span></td>
       <td><span class="comment code">    // Users with JS enabled will never see initially blank values for the end
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">385</span></td>
       <td><span class="comment code">    // date (see Drupal.date.EndDateHandler()), so hide the message for them.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">386</span></td>
       <td><span class="missed code">    $description .= '&lt;span class=&quot;js-hide&quot;&gt; ' . t(&quot;Empty 'End date' values will use the 'Start date' values.&quot;) . '&lt;/span&gt;';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">387</span></td>
       <td><span class="missed code">    $element['#fieldset_description'] = $description;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">388</span></td>
       <td><span class="missed code">    if ($field['settings']['todate'] == 'optional') {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">389</span></td>
       <td><span class="missed code">      $element[$to_field]['#states'] = array(
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">390</span></td>
       <td><span class="comment code">        'visible' =&gt; array(
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">391</span></td>
       <td><span class="missed code">          'input[name=&quot;' . $show_id . '&quot;]' =&gt; array(
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">392</span></td>
       <td><span class="missed code">            'checked' =&gt; TRUE,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">393</span></td>
       <td><span class="missed code">          ),
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">394</span></td>
       <td><span class="missed code">        ),
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">395</span></td>
       <td><span class="comment code">      );
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">396</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">397</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">398</span></td>
       <td><span class="comment code">  else {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">399</span></td>
       <td><span class="missed code">    $element[$from_field]['#description'] = $description;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">400</span></td>
       <td><span class="comment code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">401</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">402</span></td>
       <td><span class="comment code">  // Create label for error messages that make sense in multiple values
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">403</span></td>
       <td><span class="comment code">  // and when the title field is left blank.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">404</span></td>
       <td><span class="missed code">  if ($field['cardinality'] &lt;&gt; 1 &amp;&amp; empty($field['settings']['repeat'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">405</span></td>
       <td><span class="missed code">    $element[$from_field]['#date_title'] = t('@field_name Start date value #@delta', array('@field_name' =&gt; $instance['label'], '@delta' =&gt; $delta + 1));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">406</span></td>
       <td><span class="missed code">    if (!empty($field['settings']['todate'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">407</span></td>
       <td><span class="missed code">      $element[$to_field]['#date_title'] = t('@field_name End date value #@delta', array('@field_name' =&gt; $instance['label'], '@delta' =&gt; $delta + 1));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">408</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">409</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">410</span></td>
       <td><span class="missed code">  elseif (!empty($field['settings']['todate'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">411</span></td>
       <td><span class="missed code">    $element[$from_field]['#date_title'] = t('@field_name Start date', array('@field_name' =&gt; $instance['label']));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">412</span></td>
       <td><span class="missed code">    $element[$to_field]['#date_title'] = t('@field_name End date', array('@field_name' =&gt; $instance['label']));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">413</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">414</span></td>
       <td><span class="comment code">  else {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">415</span></td>
       <td><span class="missed code">    $element[$from_field]['#date_title'] = t('@field_name', array('@field_name' =&gt; $instance['label']));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">416</span></td>
       <td><span class="comment code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">417</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">418</span></td>
       <td><span class="comment code">  // Make changes if instance is set to be rendered as a regular field.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">419</span></td>
       <td><span class="missed code">  if (!empty($instance['widget']['settings']['no_fieldset'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">420</span></td>
       <td><span class="missed code">    unset($element[$from_field]['#description']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">421</span></td>
       <td><span class="missed code">    if (!empty($field['settings']['todate']) &amp;&amp; isset($element['#description'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">422</span></td>
       <td><span class="missed code">      $element['#description'] .= '&lt;span class=&quot;js-hide&quot;&gt; ' . t(&quot;Empty 'End date' values will use the 'Start date' values.&quot;) . '&lt;/span&gt;';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">423</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">424</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">425</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">426</span></td>
       <td><span class="comment code">  $context = array(
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">427</span></td>
       <td><span class="missed code">    'field'     =&gt; $field,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">428</span></td>
       <td><span class="missed code">    'instance'  =&gt; $instance,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">429</span></td>
       <td><span class="missed code">    'form'      =&gt; $form,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">430</span></td>
       <td><span class="missed code">  );
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">431</span></td>
       <td><span class="missed code">  drupal_alter('date_combo_process', $element, $form_state, $context);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">432</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">433</span></td>
       <td><span class="missed code">  return $element;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">434</span></td>
       <td><span class="dead code">}
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">435</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">436</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">437</span></td>
       <td><span class="comment code"> * Empty a date element.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">438</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">439</span></td>
       <td><span class="covered code">function date_element_empty($element, &amp;$form_state) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">440</span></td>
       <td><span class="missed code">  $item = array();
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">441</span></td>
       <td><span class="missed code">  $item['value'] = NULL;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">442</span></td>
       <td><span class="missed code">  $item['value2']   = NULL;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">443</span></td>
       <td><span class="missed code">  $item['timezone']   = NULL;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">444</span></td>
       <td><span class="missed code">  $item['offset'] = NULL;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">445</span></td>
       <td><span class="missed code">  $item['offset2'] = NULL;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">446</span></td>
       <td><span class="missed code">  $item['rrule'] = NULL;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">447</span></td>
       <td><span class="missed code">  form_set_value($element, $item, $form_state);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">448</span></td>
       <td><span class="missed code">  return $item;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">449</span></td>
       <td><span class="dead code">}
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">450</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">451</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">452</span></td>
       <td><span class="comment code"> * Validate and update a combo element.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">453</span></td>
       <td><span class="comment code"> *
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">454</span></td>
       <td><span class="comment code"> * Don't try this if there were errors before reaching this point.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">455</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">456</span></td>
       <td><span class="covered code">function date_combo_validate($element, &amp;$form_state) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">457</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">458</span></td>
       <td><span class="comment code">  // Disabled and hidden elements won't have any input and don't need validation,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">459</span></td>
       <td><span class="comment code">  // we just need to re-save the original values, from before they were processed into
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">460</span></td>
       <td><span class="comment code">  // widget arrays and timezone-adjusted.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">461</span></td>
       <td><span class="missed code">  if (date_hidden_element($element) || !empty($element['#disabled'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">462</span></td>
       <td><span class="missed code">    form_set_value($element, $element['#date_items'], $form_state);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">463</span></td>
       <td><span class="missed code">    return;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">464</span></td>
       <td><span class="dead code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">465</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">466</span></td>
       <td><span class="missed code">  $field_name = $element['#field_name'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">467</span></td>
       <td><span class="missed code">  $delta = $element['#delta'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">468</span></td>
       <td><span class="missed code">  $langcode = $element['#language'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">469</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">470</span></td>
       <td><span class="comment code">  // Related issue: https://drupal.org/node/2279831.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">471</span></td>
       <td><span class="missed code">  if (!is_array($element['#field_parents'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">472</span></td>
       <td><span class="missed code">    $element['#field_parents'] = array();
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">473</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">474</span></td>
       <td><span class="missed code">  $form_values = drupal_array_get_nested_value($form_state['values'], $element['#field_parents']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">475</span></td>
       <td><span class="missed code">  $form_input = drupal_array_get_nested_value($form_state['input'], $element['#field_parents']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">476</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">477</span></td>
       <td><span class="comment code">  // If the whole field is empty and that's OK, stop now.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">478</span></td>
       <td><span class="missed code">  if (empty($form_input[$field_name]) &amp;&amp; !$element['#required']) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">479</span></td>
       <td><span class="missed code">    return;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">480</span></td>
       <td><span class="dead code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">481</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">482</span></td>
       <td><span class="missed code">  $item = drupal_array_get_nested_value($form_state['values'], $element['#parents']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">483</span></td>
       <td><span class="missed code">  $posted = drupal_array_get_nested_value($form_state['input'], $element['#parents']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">484</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">485</span></td>
       <td><span class="missed code">  $field = field_widget_field($element, $form_state);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">486</span></td>
       <td><span class="missed code">  $instance = field_widget_instance($element, $form_state);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">487</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">488</span></td>
       <td><span class="comment code">  $context = array(
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">489</span></td>
       <td><span class="missed code">    'field' =&gt; $field,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">490</span></td>
       <td><span class="missed code">    'instance' =&gt; $instance,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">491</span></td>
       <td><span class="missed code">    'item' =&gt; $item,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">492</span></td>
       <td><span class="missed code">  );
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">493</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">494</span></td>
       <td><span class="missed code">  drupal_alter('date_combo_pre_validate', $element, $form_state, $context);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">495</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">496</span></td>
       <td><span class="missed code">  $from_field = 'value';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">497</span></td>
       <td><span class="missed code">  $to_field = 'value2';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">498</span></td>
       <td><span class="missed code">  $tz_field = 'timezone';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">499</span></td>
       <td><span class="missed code">  $offset_field = 'offset';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">500</span></td>
       <td><span class="missed code">  $offset_field2 = 'offset2';
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">501</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">502</span></td>
       <td><span class="comment code">  // Check for empty 'Start date', which could either be an empty
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">503</span></td>
       <td><span class="comment code">  // value or an array of empty values, depending on the widget.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">504</span></td>
       <td><span class="missed code">  $empty = TRUE;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">505</span></td>
       <td><span class="missed code">  if (!empty($item[$from_field])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">506</span></td>
       <td><span class="missed code">    if (!is_array($item[$from_field])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">507</span></td>
       <td><span class="missed code">      $empty = FALSE;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">508</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">509</span></td>
       <td><span class="comment code">    else {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">510</span></td>
       <td><span class="missed code">      foreach ($item[$from_field] as $key =&gt; $value) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">511</span></td>
       <td><span class="missed code">        if (!empty($value)) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">512</span></td>
       <td><span class="missed code">          $empty = FALSE;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">513</span></td>
       <td><span class="missed code">          break;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">514</span></td>
       <td><span class="dead code">        }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">515</span></td>
       <td><span class="missed code">      }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">516</span></td>
       <td><span class="comment code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">517</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">518</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">519</span></td>
       <td><span class="comment code">  // An 'End' date without a 'Start' date is a validation error.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">520</span></td>
       <td><span class="missed code">  if ($empty &amp;&amp; !empty($item[$to_field])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">521</span></td>
       <td><span class="missed code">    if (!is_array($item[$to_field])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">522</span></td>
       <td><span class="missed code">      form_error($element, t(&quot;A 'Start date' date is required if an 'end date' is supplied for field %field #%delta.&quot;, array('%delta' =&gt; $field['cardinality'] ? intval($delta + 1) : '', '%field' =&gt; $instance['label'])));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">523</span></td>
       <td><span class="missed code">      $empty = FALSE;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">524</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">525</span></td>
       <td><span class="comment code">    else {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">526</span></td>
       <td><span class="missed code">      foreach ($item[$to_field] as $key =&gt; $value) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">527</span></td>
       <td><span class="missed code">        if (!empty($value)) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">528</span></td>
       <td><span class="missed code">          form_error($element, t(&quot;A 'Start date' date is required if an 'End date' is supplied for field %field #%delta.&quot;, array('%delta' =&gt; $field['cardinality'] ? intval($delta + 1) : '', '%field' =&gt; $instance['label'])));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">529</span></td>
       <td><span class="missed code">          $empty = FALSE;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">530</span></td>
       <td><span class="missed code">          break;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">531</span></td>
       <td><span class="dead code">        }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">532</span></td>
       <td><span class="missed code">      }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">533</span></td>
       <td><span class="comment code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">534</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">535</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">536</span></td>
       <td><span class="comment code">  // If the user chose the option to not show the end date, just swap in the
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">537</span></td>
       <td><span class="comment code">  // start date as that value so the start and end dates are the same.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">538</span></td>
       <td><span class="missed code">  if ($field['settings']['todate'] == 'optional' &amp;&amp; empty($item['show_todate'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">539</span></td>
       <td><span class="missed code">    $item[$to_field] = $item[$from_field];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">540</span></td>
       <td><span class="missed code">    $posted[$to_field] = $posted[$from_field];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">541</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">542</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">543</span></td>
       <td><span class="missed code">  if ($empty) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">544</span></td>
       <td><span class="missed code">    $item = date_element_empty($element, $form_state);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">545</span></td>
       <td><span class="missed code">    if (!$element['#required']) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">546</span></td>
       <td><span class="missed code">      return;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">547</span></td>
       <td><span class="dead code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">548</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">549</span></td>
       <td><span class="comment code">  // Don't look for further errors if errors are already flagged
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">550</span></td>
       <td><span class="comment code">  // because otherwise we'll show errors on the nested elements
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">551</span></td>
       <td><span class="comment code">  // more than once.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">552</span></td>
       <td><span class="missed code">  elseif (!form_get_errors()) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">553</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">554</span></td>
       <td><span class="missed code">    $timezone = !empty($item[$tz_field]) ? $item[$tz_field] : $element['#date_timezone'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">555</span></td>
       <td><span class="missed code">    $timezone_db = date_get_timezone_db($field['settings']['tz_handling']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">556</span></td>
       <td><span class="missed code">    $element[$from_field]['#date_timezone'] = $timezone;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">557</span></td>
       <td><span class="missed code">    $from_date = date_input_date($field, $instance, $element[$from_field], $posted[$from_field]);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">558</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">559</span></td>
       <td><span class="missed code">    if (!empty($field['settings']['todate'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">560</span></td>
       <td><span class="missed code">      $element[$to_field]['#date_timezone'] = $timezone;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">561</span></td>
       <td><span class="missed code">      $to_date = date_input_date($field, $instance, $element[$to_field], $posted[$to_field]);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">562</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">563</span></td>
       <td><span class="comment code">    else {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">564</span></td>
       <td><span class="missed code">      $to_date = $from_date;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">565</span></td>
       <td><span class="comment code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">566</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">567</span></td>
       <td><span class="comment code">    // Neither the start date nor the end date should be empty at this point
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">568</span></td>
       <td><span class="comment code">    // unless they held values that couldn't be evaluated.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">569</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">570</span></td>
       <td><span class="missed code">    if (!$instance['required'] &amp;&amp; (!date_is_date($from_date) || !date_is_date($to_date))) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">571</span></td>
       <td><span class="missed code">      $item = date_element_empty($element, $form_state);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">572</span></td>
       <td><span class="missed code">      $errors[] = t('The dates are invalid.');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">573</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">574</span></td>
       <td><span class="missed code">    elseif (!empty($field['settings']['todate']) &amp;&amp; $from_date &gt; $to_date) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">575</span></td>
       <td><span class="missed code">      form_set_value($element[$to_field], $to_date, $form_state);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">576</span></td>
       <td><span class="missed code">      $errors[] = t('The End date must be greater than the Start date.');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">577</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">578</span></td>
       <td><span class="comment code">    else {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">579</span></td>
       <td><span class="comment code">      // Convert input dates back to their UTC values and re-format to ISO
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">580</span></td>
       <td><span class="comment code">      // or UNIX instead of the DATETIME format used in element processing.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">581</span></td>
       <td><span class="missed code">      $item[$tz_field] = $timezone;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">582</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">583</span></td>
       <td><span class="comment code">      // Update the context for changes in the $item, and allow other modules to
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">584</span></td>
       <td><span class="comment code">      // alter the computed local dates.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">585</span></td>
       <td><span class="missed code">      $context['item'] = $item;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">586</span></td>
       <td><span class="comment code">      // We can only pass two additional values to drupal_alter, so $element
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">587</span></td>
       <td><span class="comment code">      // needs to be included in $context.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">588</span></td>
       <td><span class="missed code">      $context['element'] = $element;
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">589</span></td>
       <td><span class="missed code">      drupal_alter('date_combo_validate_date_start', $from_date, $form_state, $context);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">590</span></td>
       <td><span class="missed code">      drupal_alter('date_combo_validate_date_end', $to_date, $form_state, $context);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">591</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">592</span></td>
       <td><span class="missed code">      $item[$offset_field] = date_offset_get($from_date);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">593</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">594</span></td>
       <td><span class="missed code">      $test_from = date_format($from_date, 'r');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">595</span></td>
       <td><span class="missed code">      $test_to = date_format($to_date, 'r');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">596</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">597</span></td>
       <td><span class="missed code">      $item[$offset_field2] = date_offset_get($to_date);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">598</span></td>
       <td><span class="missed code">      date_timezone_set($from_date, timezone_open($timezone_db));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">599</span></td>
       <td><span class="missed code">      date_timezone_set($to_date, timezone_open($timezone_db));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">600</span></td>
       <td><span class="missed code">      $item[$from_field] = date_format($from_date, date_type_format($field['type']));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">601</span></td>
       <td><span class="missed code">      $item[$to_field] = date_format($to_date, date_type_format($field['type']));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">602</span></td>
       <td><span class="missed code">      if (isset($form_values[$field_name]['rrule'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">603</span></td>
       <td><span class="missed code">        $item['rrule'] = $form_values[$field['field_name']]['rrule'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">604</span></td>
       <td><span class="missed code">      }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">605</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">606</span></td>
       <td><span class="comment code">      // If the db timezone is not the same as the display timezone
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">607</span></td>
       <td><span class="comment code">      // and we are using a date with time granularity,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">608</span></td>
       <td><span class="comment code">      // test a roundtrip back to the original timezone to catch
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">609</span></td>
       <td><span class="comment code">      // invalid dates, like 2AM on the day that spring daylight savings
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">610</span></td>
       <td><span class="comment code">      // time begins in the US.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">611</span></td>
       <td><span class="missed code">      $granularity = date_format_order($element[$from_field]['#date_format']);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">612</span></td>
       <td><span class="missed code">      if ($timezone != $timezone_db &amp;&amp; date_has_time($granularity)) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">613</span></td>
       <td><span class="missed code">        date_timezone_set($from_date, timezone_open($timezone));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">614</span></td>
       <td><span class="missed code">        date_timezone_set($to_date, timezone_open($timezone));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">615</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">616</span></td>
       <td><span class="missed code">        if ($test_from != date_format($from_date, 'r')) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">617</span></td>
       <td><span class="missed code">          $errors[] = t('The Start date is invalid.');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">618</span></td>
       <td><span class="missed code">        }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">619</span></td>
       <td><span class="missed code">        if ($test_to != date_format($to_date, 'r')) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">620</span></td>
       <td><span class="missed code">          $errors[] = t('The End date is invalid.');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">621</span></td>
       <td><span class="missed code">        }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">622</span></td>
       <td><span class="missed code">      }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">623</span></td>
       <td><span class="missed code">      if (empty($errors)) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">624</span></td>
       <td><span class="missed code">        form_set_value($element, $item, $form_state);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">625</span></td>
       <td><span class="missed code">      }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">626</span></td>
       <td><span class="comment code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">627</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">628</span></td>
       <td><span class="missed code">  if (!empty($errors)) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">629</span></td>
       <td><span class="missed code">    if ($field['cardinality']) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">630</span></td>
       <td><span class="missed code">      form_error($element, t('There are errors in @field_name value #@delta:', array('@field_name' =&gt; $instance['label'], '@delta' =&gt; $delta + 1)) . theme('item_list', array('items' =&gt; $errors)));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">631</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">632</span></td>
       <td><span class="comment code">    else {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">633</span></td>
       <td><span class="missed code">      form_error($element, t('There are errors in @field_name:', array('@field_name' =&gt; $instance['label'])) . theme('item_list', array('items' =&gt; $errors)));
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">634</span></td>
       <td><span class="comment code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">635</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">636</span></td>
       <td><span class="missed code">}
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">637</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">638</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">639</span></td>
       <td><span class="comment code"> * Determine the input format for this element.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">640</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">641</span></td>
       <td><span class="covered code">function date_input_format($element, $field, $instance) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">642</span></td>
       <td><span class="missed code">  if (!empty($instance['widget']['settings']['input_format_custom'])) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">643</span></td>
       <td><span class="missed code">    return $instance['widget']['settings']['input_format_custom'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">644</span></td>
       <td><span class="dead code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">645</span></td>
       <td><span class="missed code">  elseif (!empty($instance['widget']['settings']['input_format']) &amp;&amp; $instance['widget']['settings']['input_format'] != 'site-wide') {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">646</span></td>
       <td><span class="missed code">    return $instance['widget']['settings']['input_format'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">647</span></td>
       <td><span class="dead code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">648</span></td>
       <td><span class="missed code">  return variable_get('date_format_short', 'm/d/Y - H:i');
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">649</span></td>
       <td><span class="dead code">}
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">650</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">651</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">652</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">653</span></td>
       <td><span class="comment code"> * Implements hook_date_select_pre_validate_alter().
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">654</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">655</span></td>
       <td><span class="covered code">function date_date_select_pre_validate_alter(&amp;$element, &amp;$form_state, &amp;$input) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">656</span></td>
       <td><span class="missed code">  date_empty_end_date($element, $form_state, $input);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">657</span></td>
       <td><span class="missed code">}
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">658</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">659</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">660</span></td>
       <td><span class="comment code"> * Implements hook_date_text_pre_validate_alter().
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">661</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">662</span></td>
       <td><span class="covered code">function date_date_text_pre_validate_alter(&amp;$element, &amp;$form_state, &amp;$input) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">663</span></td>
       <td><span class="missed code">  date_empty_end_date($element, $form_state, $input);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">664</span></td>
       <td><span class="missed code">}
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">665</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">666</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">667</span></td>
       <td><span class="comment code"> * Implements hook_date_popup_pre_validate_alter().
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">668</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">669</span></td>
       <td><span class="covered code">function date_date_popup_pre_validate_alter(&amp;$element, &amp;$form_state, &amp;$input) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">670</span></td>
       <td><span class="missed code">  date_empty_end_date($element, $form_state, $input);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">671</span></td>
       <td><span class="missed code">}
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">672</span></td>
       <td><span class="comment code">
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">673</span></td>
       <td><span class="comment code">/**
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">674</span></td>
       <td><span class="comment code"> * Helper function to clear out end date when not being used.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">675</span></td>
       <td><span class="comment code"> */
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">676</span></td>
       <td><span class="covered code">function date_empty_end_date(&amp;$element, &amp;$form_state, &amp;$input) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">677</span></td>
       <td><span class="comment code">  // If this is the end date and the option to show an end date has not been selected,
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">678</span></td>
       <td><span class="comment code">  // empty the end date to surpress validation errors and stop further processing.
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">679</span></td>
       <td><span class="missed code">  $parents = $element['#parents'];
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">680</span></td>
       <td><span class="missed code">  $parent = array_pop($parents);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">681</span></td>
       <td><span class="missed code">  if ($parent == 'value2') {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">682</span></td>
       <td><span class="missed code">    $parent_values = drupal_array_get_nested_value($form_state['values'], $parents);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">683</span></td>
       <td><span class="missed code">    if (isset($parent_values['show_todate']) &amp;&amp; $parent_values['show_todate'] != 1) {
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">684</span></td>
       <td><span class="missed code">      $input = array();
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">685</span></td>
       <td><span class="missed code">      form_set_value($element, NULL, $form_state);
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">686</span></td>
       <td><span class="missed code">    }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">687</span></td>
       <td><span class="missed code">  }
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">688</span></td>
       <td><span class="missed code">}
</span></td>
    </tr>
    <tr>
       <td><span class="lineNo">689</span></td>
       <td><span class="covered code"></span></td>
    </tr>
  </tbody>
</table>
<h2>Legend</h2>
<dl>
  <dt><span class="missed">Missed</span></dt>
  <dd>lines code that <strong>were not</strong> excersized during program execution.</dd>
  <dt><span class="covered">Covered</span></dt>
  <dd>lines code <strong>were</strong> excersized during program execution.</dd>
  <dt><span class="comment">Comment/non executable</span></dt>
  <dd>Comment or non-executable line of code.</dd>
  <dt><span class="dead">Dead</span></dt>
  <dd>lines of code that according to xdebug could not be executed.  This is counted as coverage code because 
  in almost all cases it is code that runnable.</dd>
</dl>
</body>
</html>
